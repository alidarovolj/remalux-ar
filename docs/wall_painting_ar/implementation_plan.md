# План реализации AR-приложения для покраски стен в реальном времени

## Оглавление
1. [Обзор проекта](#обзор-проекта)
2. [Технические требования](#технические-требования)
3. [Архитектурное решение](#архитектурное-решение)
4. [Компоненты системы](#компоненты-системы)
5. [План реализации](#план-реализации)
6. [Оптимизация производительности](#оптимизация-производительности)
7. [Ресурсы и модели](#ресурсы-и-модели)

## Обзор проекта

### Цель
Разработать Flutter-приложение для визуализации покраски стен в реальном времени, аналогичное Dulux Visualizer. Приложение должно:
- Распознавать стены через камеру устройства
- Позволять пользователю выбирать цвет/текстуру
- Применять выбранный цвет к стене по нажатию
- Отображать результат в реальном времени с учетом перспективы и освещения

### Ключевые особенности
- **Точная сегментация стен** - границы покраски должны точно соответствовать реальным границам стен
- **Реалистичная визуализация** - сохранение текстуры, теней и освещения оригинальной стены
- **Стабильный трекинг** - покраска должна оставаться на месте при движении камеры
- **Обработка окклюзий** - корректное отображение при наличии мебели или людей перед стеной

## Технические требования

### Платформы
- iOS 12.0+ (ARKit 3.0+)
- Android API 24+ (ARCore поддержка)

### Производительность
- Минимум 15 FPS для сегментации
- 30-60 FPS для рендеринга AR сцены
- Задержка < 200мс от нажатия до применения цвета

### Точность
- Сегментация стен с точностью ±5 пикселей от реальных границ
- Поддержка сложных контуров (окна, двери, розетки)

## Архитектурное решение

### Выбор технологического стека

После анализа доступных решений, рекомендуется **гибридный подход**:

1. **Для прототипа и MVP**: использовать `ar_flutter_plugin` с классической сегментацией (Canny + Flood Fill)
2. **Для продакшн версии**: интегрировать Unity как библиотеку для максимальной производительности

### Обоснование

**ar_flutter_plugin (для MVP)**:
- ✅ Быстрая интеграция
- ✅ Достаточно для базовой функциональности
- ❌ Ограниченные возможности процедурной геометрии
- ❌ Сложности с доступом к видеопотоку для ML

**Unity как библиотека (для продакшн)**:
- ✅ Полный контроль над рендерингом
- ✅ Нативная поддержка процедурной генерации мешей
- ✅ Прямой доступ к видеопотоку AR сессии
- ✅ GPU-ускоренная обработка изображений
- ❌ Сложная начальная настройка
- ❌ Увеличение размера приложения

## Компоненты системы

### 1. Модуль захвата и предобработки изображений

```dart
class CameraFrameProcessor {
  // Конвертация YUV -> RGB
  // Масштабирование для ML (720p)
  // Кеширование кадров
}
```

### 2. Модуль сегментации стен

#### Классический подход (Imaggle-inspired)
1. **Edge Detection**: Canny с адаптивными порогами
2. **Flood Fill**: От точки нажатия до границ
3. **Mask Refinement**: Эрозия для стабильности
4. **Tracking**: Использование предыдущей маски как предиктора

#### ML подход
- **Модель**: DeepLabv3+ с MobileNetV3 backbone
- **Датасет**: ADE20K (содержит класс "wall")
- **Оптимизация**: TFLite с квантизацией INT8

### 3. Модуль генерации геометрии

```dart
class WallMeshGenerator {
  // Контур стены -> Триангуляция (Earcut)
  // Проекция 2D -> 3D координаты
  // Генерация UV координат для текстур
}
```

### 4. Модуль рендеринга

- **Материалы**: Динамическое создание с учетом освещения
- **Окклюзия**: Использование Depth API / LiDAR
- **Блендинг**: 60% новый цвет + 40% оригинал

## План реализации

### ✅ Фаза 1: MVP с ar_flutter_plugin **ЗАВЕРШЕНО**

#### ✅ Неделя 1: Базовая инфраструктура
- ✅ Настройка проекта с ar_flutter_plugin
- ✅ Реализация детекции вертикальных плоскостей
- ✅ Базовый UI для выбора цвета (ColorPicker)
- ✅ Hit-testing и определение точки нажатия
- ✅ BLoC архитектура (ARWallPainterBloc)

#### ✅ Неделя 2: Сегментация и визуализация
- ✅ Реализация Stanford алгоритма (Canny + Flood Fill)
- ✅ 2D overlay с альфа-блендингом
- ✅ Базовая стабилизация маски
- ✅ Интеграция с камерой

### ✅ Фаза 2: ML сегментация **ЗАВЕРШЕНО**

#### ✅ Неделя 3: Интеграция модели
- ✅ Интеграция DeepLabv3+ и SegFormer моделей
- ✅ TensorFlow Lite интеграция с GPU поддержкой
- ✅ MLWallSegmentationService реализация
- ✅ Оптимизация производительности (320x240px обработка)

#### ✅ Неделя 4: Гибридный подход
- ✅ HybridWallPainterService с 4 режимами работы
- ✅ Автоматический выбор алгоритмов
- ✅ Трекинг производительности (20-item history)
- ✅ Fallback стратегии и обработка ошибок

### ✅ Фаза 2.5: 3D AR реализация **ЗАВЕРШЕНО**

#### ✅ Настоящая AR детекция плоскостей
- ✅ AR3DWallPainterScreen с детекцией плоскостей
- ✅ Создание AR якорей на плоскостях
- ✅ 3D размещение объектов в AR пространстве
- ✅ Замена 2D overlay на реальный AR
- ✅ Интеграция с существующим BLoC

### ⏳ Фаза 3: Unity интеграция **ПЛАНИРУЕТСЯ**

#### Неделя 5-6: Базовая интеграция
- [ ] Настройка flutter-unity-view-widget
- [ ] Миграция логики сегментации в Unity
- [ ] GPU-ускоренная обработка изображений

#### Неделя 7: Продвинутый рендеринг
- [ ] Процедурная генерация мешей
- [ ] Реалистичное освещение
- [ ] Обработка окклюзий

### ✅ Фаза 4: Полировка и оптимизация **ЧАСТИЧНО ЗАВЕРШЕНО**
- ✅ Производительность 30+ FPS
- ✅ UI/UX улучшения (панели управления, индикаторы)
- ✅ Обработка edge cases (iOS ML проблемы)
- ✅ Предупреждения о режимах работы
- [ ] Финальная подготовка к релизу

## Оптимизация производительности

### Стратегии оптимизации

1. **Многопоточность**
   - Сегментация в отдельном isolate
   - Асинхронная триангуляция

2. **GPU ускорение**
   - Metal/Vulkan шейдеры для фильтров
   - Compute shaders для YUV->RGB

3. **Адаптивное качество**
   - Динамическое изменение разрешения
   - Throttling частоты сегментации

4. **Кеширование**
   - Переиспользование масок при малом движении
   - Предиктивная сегментация

### Целевые метрики

| Операция | Целевое время | Приоритет |
|----------|---------------|-----------|
| Сегментация кадра | < 50ms | Высокий |
| Триангуляция | < 10ms | Средний |
| Рендеринг | < 16ms | Критический |
| Hit-test | < 5ms | Высокий |

## Ресурсы и модели

### ML модели

1. **DeepLabv3+ (ADE20K)**
   - Размер: ~50MB (MobileNetV3)
   - Точность: 78% mIoU
   - [TensorFlow Hub](https://tfhub.dev/tensorflow/lite-model/deeplabv3/1/metadata/2)

2. **SegFormer (ADE20K)**
   - Размер: ~15MB (B0 variant)
   - Точность: 76% mIoU
   - Более современная архитектура

### Библиотеки

```yaml
dependencies:
  ar_flutter_plugin: ^0.7.3
  tflite_flutter: ^0.10.0
  image: ^4.0.0
  flutter_colorpicker: ^1.0.3
  
  # Для Unity интеграции
  flutter_unity_widget: ^2022.2.0
```

### Platform Channels

```dart
// iOS: OpenCV интеграция
class IOSImageProcessor {
  static const platform = MethodChannel('wall_segmentation/ios');
  
  Future<Uint8List> processFrame(Uint8List frame) async {
    return await platform.invokeMethod('segmentWall', frame);
  }
}
```

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Низкая производительность ML | Высокая | Критично | Использовать классический подход как fallback |
| Сложность Unity интеграции | Средняя | Высоко | Начать с MVP на ar_flutter_plugin |
| Неточная сегментация | Средняя | Средне | Комбинировать несколько методов |
| Большой размер приложения | Высокая | Низко | Динамическая загрузка моделей |

## Заключение

Данный план обеспечивает поэтапную реализацию AR-приложения для покраски стен с возможностью быстрого создания MVP и последующего улучшения до продакшн-качества. Ключевым фактором успеха является правильный баланс между точностью сегментации и производительностью в реальном времени. 