# План по улучшению функции AR Wall Painter

## 1. Диагностика и исправление производительности [ВЫПОЛНЕНО]

- **Задача:** Исследовать и устранить проблему с удержанием `ARFrame` в `ARSession`.
- **Описание:** В логах есть предупреждения `ARSession: The delegate of ARSession is retaining X ARFrames...`. Это указывает на утечку памяти или проблему с производительностью в нативном коде iOS. Необходимо проанализировать делегат `ARSession` и убедиться, что кадры (`ARFrame`) освобождаются после обработки.
- **Статус:** **Выполнено.** Проблема решена путем обновления устаревшего плагина `ar_flutter_plugin_2` на актуальную версию `ar_flutter_plugin`. Конфликты зависимостей были разрешены с помощью `dependency_overrides`.

## 2. Интеграция модели сегментации стен

- **Задача:** Внедрить модель машинного обучения для семантической сегментации стен.
- **Описание:** Чтобы отличать стены от других объектов (мебель, телевизоры), нужно использовать модель сегментации. В проекте уже есть несколько моделей в `assets/ml/` (например, `deeplabv3` или `wall-segmentation-*.tflite`).
- **Подзадачи:**
    1.  **Выбрать модель:** Проанализировать существующие модели и выбрать наиболее подходящую по точности и производительности для мобильных устройств.
    2.  **Загрузка модели:** Реализовать загрузку модели TFLite/ONNX в Flutter-приложении с помощью соответствующего плагина (например, `tflite_flutter`).
    3.  **Передача кадров:** Настроить передачу видеокадров из нативной части (ARKit) в Dart для обработки моделью. Возможно, текущий механизм потребует оптимизации.
    4.  **Обработка кадров:** Запускать модель на каждом кадре (или на каждом n-ном кадре, чтобы не терять производительность).
    5.  **Получение маски:** Обработать результат работы модели — сегментационную маску. Нужно будет выделить пиксели, классифицированные как "стена".

## 3. Улучшение логики отрисовки

- **Задача:** Модифицировать текущую логику отрисовки, чтобы она использовала маску сегментации.
- **Описание:** Текущий механизм покраски должен быть изменен. Отрисовка должна происходить только в тех областях, которые модель определила как стена. Это предотвратит закрашивание посторонних объектов.
- **Подзадачи:**
    1.  **Применение маски:** Интегрировать маску стены в шейдер или логику рендеринга, отвечающую за покраску.
    2.  **Визуализация границ:** (Опционально) Можно добавить визуальную обратную связь для пользователя, подсвечивая контуры обнаруженных стен перед началом покраски.

## 4. Тестирование и отладка

- **Задача:** Тщательно протестировать новую функциональность.
- **Описание:** Проверить работу на разных устройствах и в различных условиях освещения и интерьера.
- **Критерии успеха:**
    - Приложение не "тормозит" и не "вылетает" во время использования AR.
    - Стены определяются корректно.
    - Покраска не затрагивает мебель, окна, двери и другие объекты на стенах.
    - Пользовательский опыт интуитивно понятен. 